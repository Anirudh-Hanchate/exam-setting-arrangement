<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Exam Seating Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 2rem; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 2rem; }
        form { display: flex; flex-direction: column; gap: 1.5rem; }
        fieldset { border: 1px solid #ddd; border-radius: 5px; padding: 1.5rem; }
        legend { font-weight: 600; color: #3498db; padding: 0 0.5rem; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500; }
        input[type="text"], input[type="number"], input[type="file"] { padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; box-sizing: border-box; width: 100%; }
        input:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); }
        input[type="file"] { padding: 0.6rem; }
        .room-group { display: grid; grid-template-columns: 3fr 1fr 1fr auto; gap: 1rem; align-items: flex-end; padding: 1rem; border-radius: 5px; background-color: #f9f9f9; margin-bottom: 1rem; border-left: 3px solid #3498db; }
        .student-group-summary, .student-group-manual { display: grid; gap: 1rem; align-items: flex-end; padding: 1rem; border-radius: 5px; background-color: #f9f9f9; margin-bottom: 1rem; border-left: 3px solid #2ecc71; }
        .student-group-manual { grid-template-columns: repeat(4, 1fr) auto; }
        .student-group-manual .manual-usn-list { grid-column: span 3; }
        .student-group-manual .manual-subject-code { grid-column: span 1; }
        .student-group-manual.usn-range { grid-template-columns: 2fr 3fr 1fr 1fr auto; }
        .remove-btn { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 0.75rem; cursor: pointer; font-weight: bold; transition: background-color 0.2s; height: 100%; }
        .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: -0.5rem; margin-bottom: 1rem; }
        .add-btn { background: #2ecc71; color: white; border: none; padding: 0.7rem 1.2rem; border-radius: 4px; cursor: pointer; font-weight: 500; }
        #addRoomBtn { background-color: #3498db; }
        #addManualBtn { background-color: #e67e22; }
        .submit-btn { background: #3498db; color: white; border: none; padding: 1rem; font-size: 1.1rem; font-weight: bold; border-radius: 4px; cursor: pointer; margin-top: 1rem; }
        #statusContainer { margin-top: 1.5rem; }
        #status { padding: 1rem; border-radius: 5px; }
        .status-error { background-color: #ffebee; color: #c62828; }
        .status-warning { background-color: #fffde7; color: #f57f17; }
        .status-info { background-color: #e3f2fd; color: #1565c0; }
        .status-loading { background-color: #e1f5fe; color: #0277bd; text-align: center; }
        #resultsContainer { margin-top: 2rem; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
        .export-btn { background-color: #1abc9c; color: #fff; border: none; padding: .7rem 1.2rem; border-radius: 4px; cursor: pointer; font-weight: 500; margin-left: .5rem; margin-top: 0.5rem; }
        .export-btn:hover { background-color: #16a085; }
        .report-btn { background-color: #9b59b6; }
        .report-btn:hover { background-color: #8e44ad; }
        .room-plan-group { margin-bottom: 2.5rem; }
        .room-plan-group > h2 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ddd; padding: .8rem; text-align: center; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .group-details { margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exam Seating Generator</h1>
        <form id="seatingForm">
            <fieldset>
                <legend>1. Global Bench Configuration</legend>
                <div class="form-group">
                    <label for="studentsPerBenchInput">Number of Students per Bench</label>
                    <input type="number" id="studentsPerBenchInput" min="1" required value="2">
                    <small style="font-size: 0.8rem; color: #666; margin-top: 5px;">e.g., 2 creates A,B; 3 creates A,B,A.</small>
                </div>
            </fieldset>
            <fieldset>
                <legend>2. Common Paper Groups (Optional)</legend>
                <div class="form-group">
                    <label for="commonGroupsInput">Group papers that CANNOT sit together</label>
                    <input type="text" id="commonGroupsInput" placeholder="e.g., CS,AI; 18CS51, 18EC51">
                    <small style="font-size: 0.8rem; color: #666; margin-top: 5px;">Enter pairs separated by a comma, multiple pairs by a semicolon (;).</small>
                </div>
            </fieldset>

            <fieldset>
                <legend>3. Room Data</legend>
                <div class="form-group">
                    <label for="roomPlanUpload">Upload Room Layout (PDF/Excel)</label>
                    <input type="file" id="roomPlanUpload" accept=".pdf, .xlsx, .xls">
                    <small style="font-size: 0.8rem; color: #666; margin-top: 5px;">Format: Col 1: Room, Col 2: Benches, Col 3: # of Columns, Col 4+: Benches per column.</small>
                </div>
                <div id="roomContainer"></div>
                <div class="actions">
                    <button type="button" class="add-btn" id="addRoomBtn">+ Add Room</button>
                </div>
            </fieldset>

            <fieldset>
                <legend>4. Student Data</legend>
                <div class="form-group">
                    <label for="studentDataUpload">Upload Student List (PDF/Excel)</label>
                    <input type="file" id="studentDataUpload" accept=".pdf, .xlsx, .xls">
                    <small style="font-size: 0.8rem; color: #666; margin-top: 5px;">Format: Col 2: USN, Col 4: Subject Code.</small>
                </div>
                <div id="studentDataSummary"></div>
                <div class="actions" style="margin-top: 1rem;">
                    <button type="button" class="add-btn" id="addUsnRangeBtn">+ Add USN Range</button>
                    <button type="button" class="add-btn" id="addManualUsnBtn" style="background-color: #e67e22;">+ Add Manual USNs</button>
                </div>
                <div id="manualStudentInput"></div>
            </fieldset>

            <fieldset>
                <legend>5. Export Format</legend>
                <div class="form-group">
                    <label for="outputFormatUpload">Upload Output Template (Image)</label>
                    <input type="file" id="outputFormatUpload" accept=".png, .jpeg, .jpg">
                    <small style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        Upload an image file with your college's logo and header design. The seating plan will be added below this header.
                    </small>
                </div>
            </fieldset>

            <button type="submit" class="submit-btn">Generate Seating Plan</button>
        </form>
        <div id="statusContainer"></div>
        <div id="resultsContainer"></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('seatingForm');
            const roomContainer = document.getElementById('roomContainer');
            const addRoomBtn = document.getElementById('addRoomBtn');
            const studentDataUpload = document.getElementById('studentDataUpload');
            const studentDataSummary = document.getElementById('studentDataSummary');
            const addUsnRangeBtn = document.getElementById('addUsnRangeBtn');
            const addManualUsnBtn = document.getElementById('addManualUsnBtn');
            const manualStudentInput = document.getElementById('manualStudentInput');
            const outputFormatUpload = document.getElementById('outputFormatUpload');
            const statusContainer = document.getElementById('statusContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            const roomPlanUpload = document.getElementById('roomPlanUpload');

            let lastSuccessfulResult = null;
            let uploadedStudentData = [];
            let outputTemplate = null;

            if (window.pdfjsLib) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
            }

            const addRoomGroup = (room = {}) => {
                const roomId = `room-${Date.now()}-${Math.random()}`;
                const roomGroup = document.createElement('div');
                roomGroup.className = 'room-group';
                roomGroup.id = roomId;
                roomGroup.innerHTML = `
                    <div class="form-group"><label>Room Name/No.</label><input type="text" class="room-name" placeholder="e.g., Room 101" value="${room.name || ''}" required></div>
                    <div class="form-group"><label>Total Benches</label><input type="number" class="room-benches" min="1" required placeholder="e.g., 40" value="${room.benches || ''}"></div>
                    <div class="form-group"><label>Class Columns</label><input type="number" class="room-columns" min="1" required placeholder="e.g., 3" value="${room.classColumns || ''}"></div>
                    <input type="hidden" class="room-benches-distribution" value="${room.benchesInColumns ? room.benchesInColumns.join(',') : ''}">
                    <button type="button" class="remove-btn" onclick="document.getElementById('${roomId}').remove()">X</button>
                `;
                roomContainer.appendChild(roomGroup);
            };

            const addUsnRangeGroup = () => {
                const groupId = `usn-range-${Date.now()}`;
                const groupDiv = document.createElement('div');
                groupDiv.className = 'student-group-manual usn-range';
                groupDiv.id = groupId;
                groupDiv.innerHTML = `
                    <div class="form-group"><label>Branch Name</label><input type="text" class="branch-name" placeholder="e.g., AIML" required></div>
                    <div class="form-group"><label>USN Prefix</label><input type="text" class="branch-prefix" placeholder="e.g., 1AY23AI" required></div>
                    <div class="form-group"><label>Start No.</label><input type="number" class="branch-start" placeholder="e.g., 1" min="1" required></div>
                    <div class="form-group"><label>End No.</label><input type="number" class="branch-end" placeholder="e.g., 90" min="1" required></div>
                    <button type="button" class="remove-btn" onclick="document.getElementById('${groupId}').remove()">X</button>
                    <div class="form-group" style="grid-column: 1 / span 4;"><label>Skip USN Numbers (comma-separated)</label><input type="text" class="branch-skip" placeholder="e.g., 5, 12, 45"></div>
                    <div class="form-group" style="grid-column: 1 / span 4;"><label>Subject Code</label><input type="text" class="branch-subject-code" placeholder="e.g., 18CS51" required></div>
                `;
                manualStudentInput.appendChild(groupDiv);
            };

            const addManualUsnsGroup = () => {
                const groupId = `manual-usns-${Date.now()}`;
                const groupDiv = document.createElement('div');
                groupDiv.className = 'student-group-manual';
                groupDiv.id = groupId;
                groupDiv.innerHTML = `
                    <div class="form-group"><label>Subject Code</label><input type="text" class="manual-subject-code" placeholder="e.g., 18CS51" required></div>
                    <div class="form-group manual-usn-list" style="grid-column: span 3;"><label>Manual USN List (comma-separated)</label><input type="text" class="manual-usn-list-input" placeholder="e.g., 1AY20EC001, 1AY21CS005" required></div>
                    <button type="button" class="remove-btn" onclick="document.getElementById('${groupId}').remove()">X</button>
                `;
                manualStudentInput.appendChild(groupDiv);
            };

            const parseRoomDataFromRows = (rows) => {
                const roomData = [];
                rows.forEach((row, index) => {
                    if (index === 0 && (isNaN(parseInt(row[1])) || isNaN(parseInt(row[2])))) return;
                    if (!row || row.length < 3) return;
                    const name = String(row[0] || '').trim();
                    const totalBenches = parseInt(row[1]);
                    const numColumns = parseInt(row[2]);
                    if (!name || isNaN(totalBenches) || isNaN(numColumns)) return;
                    const benchesInColumns = row.slice(3, 3 + numColumns).map(Number);
                    const isValidDistribution = benchesInColumns.length === numColumns && !benchesInColumns.some(isNaN) && benchesInColumns.reduce((a, b) => a + b, 0) === totalBenches;
                    roomData.push({ name: name, benches: totalBenches, classColumns: numColumns, benchesInColumns: isValidDistribution ? benchesInColumns : [] });
                });
                return roomData;
            };

            const parseStudentDataFromRows = (rows) => {
                const studentData = [];
                rows.forEach((row) => {
                    if (row.length >= 4) {
                        const usn = String(row[1] || '').trim().toUpperCase();
                        const subjectCode = String(row[3] || '').trim().toUpperCase();
                        if (usn && subjectCode) {
                            studentData.push({ usn, subjectCode });
                        }
                    }
                });
                return studentData;
            };

            const displayStudentDataSummary = (students) => {
                if (students.length === 0) {
                    studentDataSummary.innerHTML = `<div class="status-info">No student data to display.</div>`;
                    return;
                }
                const groups = students.reduce((acc, student) => {
                    const usnPrefix = student.usn.substring(0, student.usn.length - 3);
                    const groupKey = `${usnPrefix.toUpperCase()}-${student.subjectCode.toUpperCase()}`;
                    if (!acc[groupKey]) {
                        acc[groupKey] = {
                            prefix: usnPrefix,
                            subjectCode: student.subjectCode,
                            count: 0,
                        };
                    }
                    acc[groupKey].count++;
                    return acc;
                }, {});

                let summaryHtml = '';
                Object.values(groups).sort((a,b) => a.prefix.localeCompare(b.prefix)).forEach(group => {
                    summaryHtml += `
                        <div class="student-group-summary">
                            <div>
                                <h4>Branch: ${group.prefix}</h4>
                                <small>Subject: ${group.subjectCode}</small>
                            </div>
                            <div>
                                <h4>Total Students: ${group.count}</h4>
                            </div>
                        </div>
                    `;
                });
                studentDataSummary.innerHTML = summaryHtml;
                uploadedStudentData = students;
                statusContainer.innerHTML = `<div id="status" class="status-info">Successfully parsed ${students.length} students. They are now ready for seating.</div>`;
            };

            const handleFileUpload = async (file, parserFunction, uiUpdater) => {
                statusContainer.innerHTML = '<div id="status" class="status-loading">Processing file...</div>';
                const fileName = file.name.toLowerCase();
                let parsedData = [];

                try {
                    if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonRows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                            parsedData = parserFunction(jsonRows);
                            uiUpdater(parsedData);
                        };
                        reader.readAsArrayBuffer(file);
                    } else if (fileName.endsWith('.pdf')) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const typedarray = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            let allRows = [];
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                if (textContent.items.length === 0) continue;
                                const lines = new Map();
                                textContent.items.forEach(item => { const y = Math.round(item.transform[5]); if (!lines.has(y)) lines.set(y, []); lines.get(y).push({ x: item.transform[4], text: item.str }); });
                                const sortedLines = Array.from(lines.entries()).sort((a, b) => b[0] - a[0]);
                                sortedLines.forEach(([y, items]) => { const rowText = items.sort((a, b) => a.x - b.x).map(item => item.text).join(' '); const cells = rowText.split(/\s{2,}/).map(s => s.trim()).filter(Boolean); if (cells.length > 1) allRows.push(cells); });
                            }
                            parsedData = parserFunction(allRows);
                            uiUpdater(parsedData);
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        alert('Unsupported file type. Please upload a PDF or Excel file.');
                        statusContainer.innerHTML = '';
                    }
                } catch (error) {
                    statusContainer.innerHTML = `<div id="status" class="status-error"><b>Error:</b> Could not parse file. It might be an image or have a complex format.</div>`;
                    console.error(error);
                }
            };
            
            outputFormatUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    outputTemplate = null;
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    outputTemplate = e.target.result;
                    statusContainer.innerHTML = `<div id="status" class="status-info">Output template successfully uploaded.</div>`;
                };
                reader.onerror = () => {
                    statusContainer.innerHTML = `<div id="status" class="status-error"><b>Error:</b> Could not read the output template file.</div>`;
                    outputTemplate = null;
                };
                reader.readAsDataURL(file);
            });

            roomPlanUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                handleFileUpload(file, parseRoomDataFromRows, (rooms) => {
                    roomContainer.innerHTML = '';
                    rooms.forEach(addRoomGroup);
                });
                event.target.value = null;
            });

            studentDataUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                handleFileUpload(file, parseStudentDataFromRows, (students) => {
                    displayStudentDataSummary(students);
                });
                event.target.value = null;
            });

            addRoomBtn.addEventListener('click', () => addRoomGroup());
            addUsnRangeBtn.addEventListener('click', addUsnRangeGroup);
            addManualUsnBtn.addEventListener('click', addManualUsnsGroup);

            form.addEventListener('submit', async e => {
                e.preventDefault();
                statusContainer.innerHTML = '<div id="status" class="status-loading">Generating plan...</div>';
                resultsContainer.innerHTML = "";
                lastSuccessfulResult = null;

                const manualStudents = [];
                const skippedStudents = {};
                
                document.querySelectorAll('.student-group-manual').forEach(group => {
                    const isUsnRange = group.classList.contains('usn-range');
                    if (isUsnRange) {
                        try {
                            const name = group.querySelector(".branch-name").value.trim().toUpperCase();
                            const prefix = group.querySelector(".branch-prefix").value.trim().toUpperCase();
                            const start = parseInt(group.querySelector(".branch-start").value);
                            const end = parseInt(group.querySelector(".branch-end").value);
                            const skipString = group.querySelector(".branch-skip").value.trim();
                            const subjectCode = group.querySelector(".branch-subject-code").value.trim().toUpperCase();

                            const fullUsnList = [];
                            for (let i = start; i <= end; i++) {
                                fullUsnList.push(`${prefix}${String(i).padStart(3, '0')}`);
                            }
                            const skipped = new Set(skipString.split(',').map(s => `${prefix}${String(parseInt(s.trim())).padStart(3, '0')}`).filter(u => u !== `${prefix}NaN`));
                            const validUsns = fullUsnList.filter(usn => !skipped.has(usn));
                            if (skipped.size > 0) {
                                skippedStudents[name] = [...skipped].sort();
                            }
                            validUsns.forEach(usn => manualStudents.push({ usn, subjectCode }));
                        } catch (err) {
                            statusContainer.innerHTML = `<div id="status" class="status-error"><b>Error in manual USN range entry:</b> ${err.message}. Please check your inputs.</div>`;
                            return;
                        }
                    } else {
                        try {
                            const usnList = group.querySelector(".manual-usn-list-input").value;
                            const subjectCode = group.querySelector(".manual-subject-code").value.trim().toUpperCase();
                            if (usnList && subjectCode) {
                                const usns = usnList.split(',').map(u => u.trim().toUpperCase()).filter(Boolean);
                                usns.forEach(usn => manualStudents.push({ usn, subjectCode }));
                            }
                        } catch (err) {
                            statusContainer.innerHTML = `<div id="status" class="status-error"><b>Error in manual USN list entry:</b> ${err.message}. Please check your inputs.</div>`;
                            return;
                        }
                    }
                });

                const combinedStudentData = [...uploadedStudentData, ...manualStudents];

                const allotmentData = {
                    studentsPerBench: document.getElementById("studentsPerBenchInput").value,
                    commonPaperGroups: document.getElementById("commonGroupsInput").value,
                    roomConfigurations: [],
                    combinedStudentData: combinedStudentData,
                    skippedStudentsReport: skippedStudents
                };

                document.querySelectorAll(".room-group").forEach(group => {
                    const roomConfig = {
                        name: group.querySelector(".room-name").value,
                        benches: group.querySelector(".room-benches").value,
                        classColumns: group.querySelector(".room-columns").value,
                    };
                    const distribution = group.querySelector(".room-benches-distribution").value;
                    if (distribution) {
                        roomConfig.benchesInColumns = distribution.split(',').map(Number);
                    }
                    allotmentData.roomConfigurations.push(roomConfig);
                });

                try {
                    const response = await fetch("http://127.0.0.1:5000/api/generate-allotment", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(allotmentData) });
                    const result = await response.json();
                    if (response.ok && result.status === "success") {
                        statusContainer.innerHTML = "";
                        lastSuccessfulResult = result;
                        displayResults(result);
                    } else {
                        throw new Error(result.message || "An unknown server error occurred.");
                    }
                } catch (error) {
                    statusContainer.innerHTML = `<div id="status" class="status-error"><b>Error:</b> ${error.message}</div>`;
                    console.error("API Error:", error);
                }
            });

            addRoomGroup();

            const exportSummaryReport = () => { if (!lastSuccessfulResult) return; const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' }); doc.setFontSize(18); doc.text("Exam Administration Summary Report", 14, 22); let startY = 30; const addReportSection = (title, data, columns, color) => { if (!data || Object.keys(data).length === 0) return; const filteredData = Object.entries(data).filter(([key, values]) => values.length > 0); if(filteredData.length === 0) return; if (startY > 240) { doc.addPage(); startY = 22; } doc.setFontSize(14); doc.text(title, 14, startY); const body = filteredData.map(([key, values]) => [key, Array.isArray(values) ? values.join(', ') : `${values.length} student(s)`]); doc.autoTable({ head: [columns], body: body, startY: startY + 6, theme: 'striped', headStyles: { fillColor: color } }); startY = doc.autoTable.previous.finalY + 15; }; addReportSection("Skipped (Ineligible) Students", lastSuccessfulResult.skipped_students, ['Branch', 'Skipped USNs'], [231, 76, 60]); addReportSection("Unseated Students", lastSuccessfulResult.unseated_students, ['Branch / Group', 'Count Remaining'], [243, 156, 18]); doc.save('summary-report.pdf'); };

            const exportRoomLayoutsToPdf = () => {
                if (!lastSuccessfulResult) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a4' });
                const groupMap = lastSuccessfulResult.group_map;

                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                const generateAndSave = (headerImage) => {
                    lastSuccessfulResult.room_arrangements.forEach((roomPlan, roomIndex) => {
                        if (roomIndex > 0) doc.addPage({ orientation: 'l', format: 'a4' });
                        
                        const margin = 10;
                        const headerHeight = 30; // 30mm for the header
                        const tableStartY = margin + headerHeight + 5; // Start tables 5mm below the header
                        const tableMarginLeft = 10;
                        const tableMarginRight = 10;
                        const summaryStartY = pageHeight - 20;
                        const roomSubjectCounts = {};

                        // Add the header image if available
                        if (headerImage) {
                            // The image needs to be resized to fit the width and the fixed header height
                            doc.addImage(headerImage, 'PNG', 0, 0, pageWidth, headerHeight);
                        } else {
                            // Fallback to text if no image is provided
                            doc.setFontSize(18);
                            doc.setFont(undefined, 'bold');
                            doc.text("Exam Seating Plan", pageWidth / 2, margin + 5, { align: 'center' });
                        }
                        
                        // Calculate subject counts for the summary
                        roomPlan.arrangement_by_column.forEach(column => {
                            column.seating_plan.forEach(bench => {
                                bench.seats.forEach(usn => {
                                    if (usn && usn !== "---") {
                                        for (const subjectCode in groupMap) {
                                            if (groupMap[subjectCode].includes(usn)) {
                                                roomSubjectCounts[subjectCode] = (roomSubjectCounts[subjectCode] || 0) + 1;
                                                break;
                                            }
                                        }
                                    }
                                });
                            });
                        });
                        
                        doc.setFontSize(18);
                        doc.setFont(undefined, 'bold');
                        doc.text(`CLASS ROOM NUMBER: ${roomPlan.room_name}`, pageWidth / 2, tableStartY - 10, { align: 'center' });
                        doc.setFont(undefined, 'normal');
                        
                        roomPlan.arrangement_by_column.forEach((columnGroup, colIndex) => {
                            const numColumns = roomPlan.arrangement_by_column.length;
                            const availableWidth = pageWidth - (tableMarginLeft + tableMarginRight);
                            const columnWidth = availableWidth / numColumns;
                            const startX = tableMarginLeft + (colIndex * columnWidth);
                            
                            const head = [['Bench', ...lastSuccessfulResult.student_seat_headers.map((h, i) => `Seat ${String.fromCharCode(65 + i)}`)]];
                            const body = columnGroup.seating_plan.map(bench => [bench.bench_number, ...bench.seats]);
                            
                            doc.autoTable({
                                head: head, body: body, startY: tableStartY, theme: 'grid',
                                headStyles: { fillColor: [44, 62, 80], textColor: 255, fontSize: 9 },
                                bodyStyles: { fontSize: 9, cellPadding: 1.5 },
                                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 14 } },
                                margin: { left: startX, right: pageWidth - (startX + columnWidth) },
                                tableWidth: 'auto',
                            });
                        });
                        
                        if (Object.keys(roomSubjectCounts).length > 0) {
                            const summaryText = "Room Summary: " + Object.entries(roomSubjectCounts)
                                .map(([subjectCode, count]) => `${subjectCode}: ${count} student(s)`)
                                .join('   |   ');
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.text(summaryText, margin, summaryStartY);
                        }
                    });
                    doc.save('classroom-seating-layouts.pdf');
                };

                if (outputTemplate) {
                    const img = new Image();
                    img.onload = () => {
                        generateAndSave(img);
                    };
                    img.onerror = () => {
                        console.error("Error loading image template. Proceeding without template.");
                        generateAndSave(null);
                    };
                    img.src = outputTemplate;
                } else {
                    generateAndSave(null);
                }
            };

            const displayResults = (data) => {
                let statusHTML = '';
                const skipped = data.skipped_students;
                if (skipped && Object.keys(skipped).length > 0) {
                    statusHTML += `<div id="status" class="status-info" style="margin-bottom:1rem"><strong>Skipped (ineligible):</strong><ul style="margin-top:.5rem;columns:2;list-style-position:inside">`;
                    Object.entries(skipped).forEach(([e, s]) => { statusHTML += `<li><b>${e}:</b> ${s.join(", ")}</li>` });
                    statusHTML += `</ul></div>`;
                }
                const unseated = data.unseated_students;
                const hasUnseated = unseated && Object.values(unseated).some(list => list.length > 0);
                if (hasUnseated) {
                    statusHTML += `<div id="status" class="status-warning"><strong>Warning: Some students unseated.</strong><ul style="margin-top:.5rem;list-style-position:inside">`;
                    Object.entries(unseated).forEach(([o, s]) => { if (s.length > 0) statusHTML += `<li><b>${o}:</b> ${s.length} student(s) remain.</li>` });
                    statusHTML += `</ul></div>`;
                }
                statusContainer.innerHTML = statusHTML;
                let resultsHTML = `
                    <div class="results-header">
                        <h2>Generated Seating Plans</h2>
                        <div>
                            <button id="exportLayoutsBtn" class="export-btn">Export Room Layouts (PDF)</button>
                            <button id="exportReportBtn" class="export-btn report-btn">Export Summary Report (PDF)</button>
                        </div>
                    </div>
                    <div id="resultsTableContainer" style="margin-top: 1rem;">`;
                data.room_arrangements.forEach(roomPlan => {
                    resultsHTML += `<div class="room-plan-group"><h2>${roomPlan.room_name}</h2>`;
                    roomPlan.arrangement_by_column.forEach(columnGroup => {
                        resultsHTML += `<div><h3>${columnGroup.name}</h3>`;
                        resultsHTML += `<table><thead><tr><th>Bench #</th>`;
                        data.student_seat_headers.forEach(header => {
                            resultsHTML += `<th>${header}</th>`;
                        });
                        resultsHTML += '</tr></thead><tbody>';
                        columnGroup.seating_plan.forEach(bench => {
                            resultsHTML += `<tr><td><b>${bench.bench_number}</b></td>`;
                            bench.seats.forEach(seat => {
                                resultsHTML += `<td>${seat}</td>`;
                            });
                            resultsHTML += '</tr>';
                        });
                        resultsHTML += '</tbody></table></div>';
                    });
                    resultsHTML += `</div>`;
                });
                resultsHTML += '</div>';
                resultsContainer.innerHTML = resultsHTML;
                document.getElementById('exportLayoutsBtn').addEventListener('click', exportRoomLayoutsToPdf);
                document.getElementById('exportReportBtn').addEventListener('click', exportSummaryReport);
            };
        });
    </script>
</body>
</html>